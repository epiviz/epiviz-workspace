<!-- Polymer dependency -->
<link rel="import" href="../polymer/polymer.html">

<!-- External Polymer imports dependency -->
<link rel="import" href="../polymerfire/firebase.html">
<link rel="import" href="../polymerfire/firebase-app.html">
<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="../polymerfire/firebase-document.html">

<!-- Style imports -->
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-dropdown-input/paper-dropdown-input.html">

<!--
`<epiviz-workspace>` manages user workspaces.

To use, add `<epiviz-workspace>` in the page

      <epiviz-workspace></epiviz-workspace>

@demo demo/index.html Example page showing a workspace element
-->

<dom-module id="epiviz-workspace">

    <template>
        <style>
            :host {
            }
        </style>

        <!-- local DOM goes here -->
        <firebase-app
            auth-domain="{{authDomain}}"
            database-url="{{databaseUrl}}"
            api-key="{{apiKey}}"
            storage-bucket="{{storageBucket}}"
            messaging-sender-id="{{messagingSenderId}}">
        </firebase-app>

        <firebase-auth id="auth" 
            user="{{user}}" 
            provider="google" 
            on-error="errorHandler">
        </firebase-auth>

        <firebase-document id="document"
            path="/{{user.uid}}"
            data="{{workspace}}">
        </firebase-document>
        <paper-dropdown-input 
        label="Workspace Name" 
        value="{{title}}"
        items="{{values}}"
        freedom="true">
        </paper-dropdown-input>
        <paper-button raised
            on-tap="save">
            <iron-icon icon="save"></iron-icon>
            Save
        </paper-button>
        <paper-button raised
            on-tap="load">
            <iron-icon icon="cloud-download"></iron-icon>
            Load
        </paper-button>
        <paper-button raised 
            on-tap="login" 
            hidden$="{{computeLoginHidden(user)}}">
            <iron-icon icon="account-circle"></iron-icon>
        Login</paper-button>
        <paper-button raised
            on-tap="logout" 
            hidden$="{{computeLogoutHidden(user)}}">
            <iron-icon icon="account-circle"></iron-icon>
        Logout</paper-button>

    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-workspace',
            // behaviors: [],

            /* Properties that can be defined on the element */
            properties: {
                /**
                 * User attribute set by firebase-auth when the user is logged in
                 *
                 * @type {Object}
                 */
                user: {
                    type: Object,
                    value: null,
                    notify: true
                },

                /**
                 * Firebase configuration: auth-domain
                 *
                 * @type {String}
                 */
                authDomain: {
                    type: String,
                    notify:true
                },

                /**
                 * Firebase configuration: database-url
                 *
                 * @type {String}
                 */
                databaseUrl: {
                    type: String,
                    notify:true
                },

                /**
                 * Firebase configuration: api-key
                 *
                 * @type {String}
                 */
                apiKey: {
                    type: String,
                    notify:true
                },
                
                /**
                 * Firebase configuration: storage-bucket
                 *
                 * @type {String}
                 */
                storageBucket: {
                    type: String,
                    notify:true
                },

                /**
                 * Firebase configuration: messaging-sender-id
                 *
                 * @type {String}
                 */   
                messagingSenderId: {
                    type: String,
                    notify:true
                },

                /**
                 * Firebase workspace object
                 *
                 * @type {Object}
                 */  
                workspace: {
                    type: Object,
                    observer: '_workspaceChanged'
                },

                /**
                 * Local variable to contain uncommitted changes in environments
                 *
                 * @type {String}
                 */  
                environments: {
                    type: Object,
                },

                /**
                 * Workspace title
                 *
                 * @type {String}
                 */  
                title: {
                    type: String,
                    notify: true,
                    observer: '_titleChanged'
                },

                remote_environments: {
                    type: Object,
                    notify: true,
                },

                /**
                 * Array of workspace names to populate dropdown
                 *
                 * @type {Array}
                 */      
                values: {
                    type: Array,
                    notify: true,
                    value: []
                }
            },

            _titleChanged: function() {
                var self = this;
                if (this.values.indexOf(this.title) != -1) {
                    this.$.document.getStoredValue(this.user.uid + "/" + this.title).then(function(data) {
                        self.remote_environments = data;
                    });
                }
            },

            _workspaceChanged: function() {
                var self = this;
                if (Object.keys(this.workspace).length != 0 && this.user) {
                    this.$.document.getStoredValue(this.user.uid).then(function(data) {
                        self.values = Object.keys(data);
                        console.log(self.values);
                        console.log(data);
                    });
                }
            },

            /**
             * Login handler function. uses provider defined in the firebase-auth element.
             */
            login: function() {
                this.$.auth.signInWithPopup()
                    .then(function(response) {
                        // optionally handle a successful login
                        console.log(response);
                    })
                    .catch(function(error) {
                        // unsuccessful authentication response here
                        console.log(error);
                    });
            },

            /**
             * Logout handler function.
             */
            logout: function() {
                this.$.auth.signOut();
            },

            /**
             * Login/Logout error handler function.
             */
            errorHandler: function(e) {
                console.log('Error: ' + e.detail.message);
            },

            /**
             * Shows/hides login button
             * @return {boolean} True if user is logged in
             */
            computeLoginHidden: function(user) {
                return !!user;
            },

            /**
             * shows/hides logout button
             * @return {boolean} True if user is not logged in
             */
            computeLogoutHidden: function(user) {
                return !user;
            },

            /**
             * Saving function
             */
            save: function() {
                //temp variables for scope
                var workspace = this.workspace;
                var env = this.environments;
                var doc = this.$.document;
                var uid = this.user.uid;
                var title = this.title;
                console.log(this.title);
                if (!title) {
                    alert("Please provide a title for the workspace.");
                } else if (!this.validate(title)) { 
                    alert("Please enter a title with no special characters")
                } else {
                    Object.keys(this.environments).forEach(function(e) {
                        console.log(env[e])
                        doc.path = null;
                        doc.data = env[e];
                        doc.saveValue(uid + "/" + title, e);
                    });                    
                }

            },

            load: function() {
                var self = this;
                if (Object.keys(this.remote_environments).length !== 0) {
                    console.log(this.remote_environments);
                    $('epiviz-environment').remove();
                    Object.keys(this.remote_environments).forEach(function(environment) {
                        var env = "<epiviz-environment workspace='" + JSON.stringify(self.remote_environments[environment]) +"'> </epiviz-environment>"
                        $('body').append(env);
                    });
                } else {
                    alert("Unable to load selected environment, environment does not exist in database");
                }
            },

            validate: function(title) {
                return /^[a-zA-Z0-9- ]*$/.test(title)
            },  

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {
                // temp variables to handle scoping issues
                var w = this.workspace;
                var env = this.environments;
                document.addEventListener('workspaceChanged', function(e) {
                    var id = e.detail.id;
                    console.log(id);
                    //replace with value received from environments
                    env[id] = e.detail.data;
                });
            },

            /* callback function after the element is initialized */
            ready: function() {
                this.environments = {};
                this.remote_environments = {};
            }
        });
    </script>
</dom-module>